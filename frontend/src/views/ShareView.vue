<template>
    <div class="share-view">
        <el-row>
            <el-col :span="24">

                <el-autocomplete v-model="user_name" :fetch-suggestions="querySearchAsync" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"
                    @select="handleSelect"></el-autocomplete>
                &nbsp;
                <el-input class="input-with-select-2" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç" v-model="searchQuery"></el-input>

                <el-button type="primary" icon="el-icon-search" @click="searchShare">ÊêúÁ¥¢</el-button>
                <el-button type="danger" icon="el-icon-delete" @click="searchQuery = ''; user_name = '';">
                    Ê∏ÖÁ©∫
                </el-button>
            </el-col>
        </el-row>

        <div>
            <el-table :data="paginatedFiles" style="width: 100%" @selection-change="handleSelectionChange"
                height="calc(100vh - 180px)" @sort-change="handleSortChange" @row-dblclick="handleRowDblClick">
                <el-table-column width="150px" prop="user_name" label="ÂàÜ‰∫´ËÄÖ" sortable="custom"></el-table-column>
                <el-table-column width="200px" prop="name" label="Êñá‰ª∂Âêç" sortable="custom">
                    <template slot-scope="scope">{{ (scope.row.type === 'folder' ? 'üìÅ' : 'üìÑ') + scope.row.name
                        }}</template>
                </el-table-column>
                <el-table-column width="150px" prop="size" label="Â§ßÂ∞è" sortable="custom"></el-table-column>
                <el-table-column prop="modified" label="‰øÆÊîπÊó∂Èó¥" sortable="custom"></el-table-column>
                <el-table-column prop="created" label="ÂàõÂª∫Êó∂Èó¥" sortable="custom"></el-table-column>
                <el-table-column label="Êìç‰Ωú" width="250px">
                    <template slot-scope="scope">
                        <el-button @click="downloadFile(scope.row)" icon='el-icon-download' type="primary"
                            size="mini">‰∏ãËΩΩ</el-button>
                        <el-button @click="cancelShare(scope.row)" icon="el-icon-circle-close" type="danger"
                            size="mini">
                            ÂèñÊ∂àÂàÜ‰∫´
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>

        <div>
            <el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange"
                :current-page="currentPage" :page-sizes="[10, 20, 50, 100, 200]" :page-size="pageSize"
                layout="total, sizes, prev, pager, next, jumper" :total="total">
            </el-pagination>
        </div>

    </div>
</template>

<script>
import axios from 'axios';
// import { MessageBox } from 'element-ui';

export default {
    data() {
        return {
            users: [],
            user_name: '',
            timeout: null,

            files: [],
            searchQuery: '',
            currentPage: 1,
            pageSize: 10,
            total: 4, // Êñá‰ª∂ÊÄªÊï∞
            sortOrder: null,
            sortBy: null
        };
    },
    computed: {
        sortedFiles() {
            let sorted = [...this.files];
            if (this.sortBy) {
                sorted.sort((a, b) => {
                    if (this.sortOrder === 'ascending') {
                        return a[this.sortBy] > b[this.sortBy] ? 1 : -1;
                    } else if (this.sortOrder === 'descending') {
                        return a[this.sortBy] < b[this.sortBy] ? 1 : -1;
                    }
                    return 0;
                });
            }
            return sorted;
        },
        paginatedFiles() {
            const startIndex = (this.currentPage - 1) * this.pageSize;
            return this.sortedFiles.slice(startIndex, startIndex + this.pageSize);
        },
    },
    methods: {
        searchShare() {
            const data = {
                user_name: this.user_name,
                name: this.searchQuery
            };
            axios.post('/searchShare', data, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            })
                .then(response => {
                    const responseData = response.data;
                    if (responseData.code === "200") {
                        // Â§ÑÁêÜËøîÂõûÁöÑÊñá‰ª∂Êï∞ÊçÆ
                        this.files = responseData.data;
                        this.total = responseData.data.length;
                    } else {
                        this.$message({
                            showClose: true,
                            message: 'ÊêúÁ¥¢Â§±Ë¥•Ôºö' + responseData.msg,
                            center: true,
                            type: 'error'
                        });
                        this.files = [];
                    }
                })
                .catch(error => {
                    this.$message({
                        showClose: true,
                        message: 'ÊêúÁ¥¢ÈîôËØØÔºö' + error,
                        center: true,
                        type: 'error'
                    });
                });
        },
        cancelShare(file) {
            console.log('ÂàÜ‰∫´Êñá‰ª∂:', file);
            var fileNames = [file.name];
            const sharePath = file.path;

            axios.post('/unshare', {
                name: sharePath,
                path: fileNames
            }, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            })
                .then(response => {
                    const responseData = response.data;
                    if (responseData.code === "200") {
                        this.$message({
                            showClose: true,
                            message: file.name + 'ÂèñÊ∂àÂàÜ‰∫´ÊàêÂäüÔºö' + responseData.msg,
                            center: true,
                            type: 'success'
                        });
                        this.searchShare();
                    } else {
                        this.$message({
                            showClose: true,
                            message: 'ÂèñÊ∂àÂàÜ‰∫´Â§±Ë¥•: ' + responseData.msg,
                            center: true,
                            type: 'error'
                        });
                        this.searchShare();
                    }
                })
                .catch(error => {
                    this.$message({
                        showClose: true,
                        message: 'ÂèñÊ∂àÂàÜ‰∫´ÈîôËØØÔºö' + error,
                        center: true,
                        type: 'error'
                    });
                    this.searchShare();
                });
        },
        downloadFile(file) {
            console.log('‰∏ãËΩΩÊñá‰ª∂/ÊâìÂºÄÊñá‰ª∂Â§π:', file);

            // ÂàõÂª∫ËØ∑Ê±ÇÊï∞ÊçÆ
            const requestData = {
                path: file.path + '/' + file.name,
                user_name: file.user_name,
            };

            // ÂèëÈÄÅPOSTËØ∑Ê±ÇËé∑ÂèñÊñá‰ª∂ÁöÑblobÊï∞ÊçÆÊµÅ
            axios.post('/downloadShare', requestData, {
                responseType: 'blob', // ÊåáÂÆöÂìçÂ∫îÁ±ªÂûã‰∏∫blob
                headers: {
                    'Authorization': `${localStorage.getItem('token')}`
                }
            }).then(response => {
                // ÂàõÂª∫‰∏Ä‰∏™URLÂØπË±°ÊåáÂêëblobÊï∞ÊçÆ
                const blobUrl = window.URL.createObjectURL(new Blob([response.data]));

                // ÂàõÂª∫‰∏Ä‰∏™ÈöêËóèÁöÑÈìæÊé•ÂÖÉÁ¥†
                const link = document.createElement('a');
                link.href = blobUrl;

                // ËÆæÁΩÆ‰∏ãËΩΩÊñá‰ª∂Âêç
                link.setAttribute('download', file.name);

                // Â∞ÜÈìæÊé•ÂÖÉÁ¥†Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.appendChild(link);

                // Ê®°ÊãüÁÇπÂáª‰∏ãËΩΩ
                link.click();

                // ÁßªÈô§ÈìæÊé•ÂÖÉÁ¥†
                document.body.removeChild(link);

                // ÈáäÊîæblob URL
                window.URL.revokeObjectURL(blobUrl);
            }).catch(error => {
                this.$message({
                    showClose: true,
                    message: 'Êñá‰ª∂‰∏ãËΩΩÈîôËØØÔºö' + error,
                    center: true,
                    type: 'error'
                });
            });
        },
        handleRowDblClick(row) {
            this.downloadFile(row);
        },
        handleSelectionChange(val) {
            this.selectedFiles = val;
        },
        handleSortChange({ prop, order }) {
            this.sortBy = prop;
            this.sortOrder = order;
        },
        handleSizeChange(size) {
            this.pageSize = size;
            console.log('ÊØèÈ°µÊòæÁ§∫Êù°ÁõÆ:', size);
        },
        handleCurrentChange(page) {
            this.currentPage = page;
            console.log('ÂΩìÂâçÈ°µ:', page);
        },
        //Ê†πÊçÆËæìÂÖ•ÂÜÖÂÆπÊèê‰æõÂØπÂ∫îÁöÑËæìÂÖ•Âª∫ËÆÆ
        loadAll() {

            axios.post('/userlist', {}, {
                headers: { 'Authorization': `${localStorage.getItem('token')}` }
            })
                .then(response => {
                    const responseData = response.data;
                    if (responseData.code === "200") {
                        const transformedData = responseData.data.map(user => ({
                            value: user.account_name
                        }));
                        console.log('Âä†ËΩΩÁî®Êà∑ÊàêÂäüÔºÅ', transformedData);
                        // ËøîÂõûËΩ¨Êç¢ÂêéÁöÑÊï∞ÊçÆ
                        this.users = transformedData;
                    } else {
                        console.error('Âä†ËΩΩÁî®Êà∑Â§±Ë¥•:', responseData.msg);
                        this.users = [{ "value": "all" }];
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁî®Êà∑Â§±Ë¥•:', error);
                });
        },
        querySearchAsync(queryString, cb) {
            var users = this.users;
            var results = queryString ? users.filter(this.createStateFilter(queryString)) : users;
            cb(results);
        },
        createStateFilter(queryString) {
            return (users) => {
                return (users.value.toLowerCase().indexOf(queryString.toLowerCase()) === 0);
            };
        },
        handleSelect(item) {
            console.log(item);
        }
    },

    watch: {
        // ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñÔºåÈáçÊñ∞Âä†ËΩΩÊñá‰ª∂ÂàóË°®
        $route() {
            this.currentPage = 1; // ÈáçÁΩÆÂΩìÂâçÈ°µ
            if (this.$route.name === "sha")
                this.searchShare();
        },
    }, mounted() {
        this.searchShare(); // ÂàùÂßãÂä†ËΩΩÊñá‰ª∂
        this.loadAll(); // Âä†ËΩΩËæìÂÖ•Âª∫ËÆÆÊï∞ÊçÆ
    }
};
</script>

<style scoped>
/* ÂàÜ‰∫´È°µÈù¢ */
.share-view {
    padding: 20px;
}
/* ÊêúÁ¥¢Ê°Ü */
.input-with-select-2 {
    width: 300px;
    margin-right: 10px;
}
</style>
